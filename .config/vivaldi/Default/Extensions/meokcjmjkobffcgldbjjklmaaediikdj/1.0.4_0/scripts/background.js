!function(e){var t={};function o(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,o),r.l=!0,r.exports}o.m=e,o.c=t,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)o.d(n,r,function(t){return e[t]}.bind(null,r));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=5)}([function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.Message=class{static sendMessageWithResult(e,t){"undefined"!=typeof browser&&browser?browser.runtime.sendMessage(e).then(e=>t(e)):chrome.runtime.sendMessage(e,e=>t(e))}static sendMessage(e){"undefined"!=typeof browser&&browser?browser.runtime.sendMessage(e):chrome.runtime.sendMessage(e)}constructor(e){this.Type=e}}},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e[e.PublishActivity=0]="PublishActivity",e[e.OpenOnRemoteDevice=1]="OpenOnRemoteDevice",e[e.GetRemoteDevices=2]="GetRemoteDevices",e[e.Logout=3]="Logout",e[e.Login=4]="Login",e[e.Error=5]="Error",e[e.GetActivities=6]="GetActivities",e[e.AuthSubmit=7]="AuthSubmit"}(t.MessageType||(t.MessageType={}))},,,,function(e,t,o){"use strict";var n=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))(function(r,i){function s(e){try{c(n.next(e))}catch(e){i(e)}}function a(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){e.done?r(e.value):new o(function(t){t(e.value)}).then(s,a)}c((n=n.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const r=o(6),i=o(1),s=["UserActivity.ReadWrite.CreatedByApp","Device.Read","Device.Command","offline_access"];let a,c,u,d,l,p,h;function f(){chrome.storage.local.remove("preferred_username"),chrome.storage.local.remove("access_token"),a=void 0,c=void 0}function g(e){return n(this,void 0,void 0,function*(){chrome.tabs.query({url:e},e=>{chrome.tabs.remove(e[0].id)});const t=e.split("?")[1].split("&"),o={code:null,error:null,error_description:null};for(const e in t){const n=t[e].split("=");o[decodeURIComponent(n[0])]=decodeURIComponent(n[1])}if(null!=o.error)console.error("Error validating token: "+o),f();else{const e=o.code,t=yield(yield fetch("https://ge-functions.azurewebsites.net/api/get-token",{body:JSON.stringify({client_id:u,code:e,redirect_uri:h,scope:s.join(" ")}),method:"POST"})).json();if(void 0!==t.error)return b(new r.ErrorMessage("Error refreshing token",t.error_description)),console.error("Error validating token: "+t),void f();chrome.storage.local.set({access_token:t.access_token,refresh_token:t.refresh_token},null),a=t.access_token,c=t.refresh_token,y().then(e=>{p=e})}})}function m(){return n(this,void 0,void 0,function*(){const e=yield(yield fetch("https://ge-functions.azurewebsites.net/api/refresh-token",{body:JSON.stringify({client_id:u,redirect_uri:h,refresh_token:c,scope:s.join(" ")}),method:"POST"})).json();return void 0!==e.error?(b(new r.ErrorMessage("Error refreshing token",e.error_description)),console.error("Error refreshing token: "+e),f(),!1):(chrome.storage.local.set({access_token:e.access_token,refresh_token:e.refresh_token},null),a=e.access_token,c=e.refresh_token,!0)})}function y(e=!1){return n(this,void 0,void 0,function*(){const t=yield fetch("https://graph.microsoft.com/beta/me/devices/",{cache:"no-cache",headers:{authorization:`Bearer ${a}`,"content-type":"application/json"},method:"GET"});if(401===t.status){return console.debug("Returned 401, refreshing access token..."),(yield m())&&!e?yield y(!0):{payload:null,reason:"Could not authorize user. Please try again.",success:!1}}return{payload:(yield t.json()).value,reason:"",success:!0}})}function b(e){chrome.notifications.create("",{iconUrl:"images/icon_128.png",message:e.Description,title:e.Title,type:"basic"},null)}navigator.userAgent.includes("OPR/")?(d="Opera",l="https://timeline.dominicmaas.co.nz/assets/browsers/opera-128.png"):navigator.userAgent.includes("Vivaldi")?(d="Vivaldi",l="https://timeline.dominicmaas.co.nz/assets/browsers/vivaldi-32.png"):navigator.userAgent.includes("Chrome")?(d="Google Chrome",l="https://timeline.dominicmaas.co.nz/assets/browsers/chrome-32.png"):navigator.userAgent.includes("Firefox")&&(d="Firefox",l="https://timeline.dominicmaas.co.nz/assets/browsers/firefox.png"),console.debug("Selected Browser: "+d),navigator.userAgent.includes("Edge")||navigator.userAgent.includes("OPR/")?(u="3e8214c9-265d-42b6-aa93-bdd810fda5e6",h="https://timeline.dominicmaas.co.nz/auth-callback/index.html",console.debug("[Auth Setup] Using fallback system (Edge or Opera).")):navigator.userAgent.includes("Firefox")&&(navigator.userAgent.includes("Mobile")||navigator.userAgent.includes("Tablet"))?(u="3e8214c9-265d-42b6-aa93-bdd810fda5e6",h="https://timeline.dominicmaas.co.nz/auth-callback/index.html",console.debug("[Auth Setup] Using fallback system (Firefox Mobile).")):navigator.userAgent.includes("Firefox")?(u="6a421ae0-f2b1-4cf9-84e0-857dc0a4c9a3",h="https://5bed674f74ec59875d4860fbe854e945b81b4dac.extensions.allizom.org/",console.debug("[Auth Setup] Using Firefox based system.")):navigator.userAgent.includes("Chrome")?(u="70c5f06f-cef4-4541-a705-1adeea3fa58f",h="https://meokcjmjkobffcgldbjjklmaaediikdj.chromiumapp.org/",console.debug("[Auth Setup] Using Chrome based system.")):(u="3e8214c9-265d-42b6-aa93-bdd810fda5e6",h="https://timeline.dominicmaas.co.nz/auth-callback/index.html",console.debug("[Auth Setup] Using fallback system.")),chrome.storage.local.get(["access_token","refresh_token"],e=>{null!==e.access_token&&(a=e.access_token),null!==e.refresh_token&&(c=e.refresh_token),void 0!==a&&y().then(e=>{p=e})}),chrome.runtime.onMessage.addListener((e,t,o)=>{if(void 0!==e)if(e.Type!==i.MessageType.PublishActivity)if(e.Type!==i.MessageType.Login)if(e.Type!==i.MessageType.Logout)if(e.Type!==i.MessageType.Error){if(e.Type!==i.MessageType.AuthSubmit)return e.Type===i.MessageType.GetActivities?(function e(t=!1){return n(this,void 0,void 0,function*(){const o=yield fetch("https://graph.microsoft.com/beta/me/activities?$top=20",{cache:"no-cache",headers:{authorization:`Bearer ${a}`,"content-type":"application/json"},method:"GET"});return 401===o.status?(console.debug("Returned 401, refreshing access token..."),(yield m())&&!t?yield e(!0):{payload:null,reason:"Could not authorize user. Please try again.",success:!1}):{payload:(yield o.json()).value,reason:"",success:!0}})}().then(e=>{o(e)}),!0):e.Type===i.MessageType.GetRemoteDevices?(void 0!==p?(o(p),y().then(e=>{p=e})):y().then(e=>{p=e,o(e)}),!0):void(e.Type!==i.MessageType.OpenOnRemoteDevice||function e(t,o=!1){return n(this,void 0,void 0,function*(){const n=yield fetch("https://graph.microsoft.com/beta/me/devices/"+t.DeviceId+"/commands",{body:'{"type":"LaunchUri","payload":{"uri":"'+t.Url+'"}}',cache:"no-cache",headers:{authorization:`Bearer ${a}`,"content-type":"application/json"},method:"POST"});if(401===n.status){if(console.debug("Returned 401, refreshing access token..."),(yield m())&&!o)return yield e(t,!0);console.error("Could not authorize user. Please try again."),b(new r.ErrorMessage("Could not open link","Could not authorize user. Please try again."))}const i=yield n.json();console.debug(i)})}(e));g(e.QueryString)}else b(e);else f();else!function(){let e="https://login.microsoftonline.com/common/oauth2/v2.0/authorize";e+=`?client_id=${u}`,e+="&response_type=code",e+="&response_mode=query",e+=`&redirect_uri=${encodeURIComponent(h)}`,e+=`&scope=${encodeURIComponent(s.join(" "))}`,"3e8214c9-265d-42b6-aa93-bdd810fda5e6"===u?chrome.tabs.create({url:e}):"undefined"!=typeof browser&&browser?browser.identity.launchWebAuthFlow({interactive:!0,url:e}).then(e=>{g(e)}):chrome.identity.launchWebAuthFlow({interactive:!0,url:e},e=>{g(e)})}();else t.tab.incognito?console.debug("Tab is in incognito mode, not sending activity."):function e(t,o=!1){return n(this,void 0,void 0,function*(){if(!a)return void console.error("Unauthorized, no auth token set.");const n=(new Date).toISOString(),r=window.btoa(t.Description).replace(/\+/g,"-").replace(/\//g,"_").replace(/\=+$/,""),i=`https://graph.microsoft.com/v1.0/me/activities/${r}`,s=""===t.IconImage?l:t.IconImage,c=JSON.stringify({activationUrl:t.Description,activitySourceHost:t.OriginUrl,appActivityId:r,appDisplayName:d,fallbackUrl:t.Description,historyItems:[{activeDurationSeconds:30,startedDateTime:n}],visualElements:{attribution:{addImageQuery:!1,alternateText:t.OriginUrl,iconUrl:s},content:{$schema:"http://adaptivecards.io/schemas/adaptive-card.json",backgroundImage:t.BackgroundImage,body:[{items:[{maxLines:3,size:"large",text:t.Title,type:"TextBlock",weight:"bolder",wrap:!0},{maxLines:3,size:"default",text:t.Description,type:"TextBlock",wrap:!0}],type:"Container"}],type:"AdaptiveCard"},description:t.Description,displayText:t.Title}}),u=yield fetch(i,{body:c,cache:"no-cache",headers:{authorization:`Bearer ${a}`,"content-type":"application/json"},method:"PUT"});if(401===u.status)return console.debug("Returned 401, refreshing access token..."),(yield m())&&!o?yield e(t,!0):void console.error("Could not post activity to Windows Timeline: "+t);const p=yield u.json();console.debug(p)})}(e)})},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=o(0),r=o(1);t.ErrorMessage=class extends n.Message{constructor(e,t){super(r.MessageType.Error),this.Title=e,this.Description=t}}}]);